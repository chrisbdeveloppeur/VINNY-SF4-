{% extends 'base.html.twig' %}

{% block title %}{% include('includes/nav_title.html.twig') %} Beats{% endblock %}

{% block description %}
    <meta name="description" content="Welcome to vinnyvixi.com, the personal website of the Beat Maker Vinny Vixi. These latest productions, Beats, Video clips, and much more. Bienvenue sur vinnyvixi.com, le site personnel du Beat Maker Vinny Vixi. Ces dernières Prods, Beats, Clip vidéos, et d'autre de contenue.">
{% endblock %}


{% block titre_landscape %}
    Beats
{% endblock %}

{% block titre %}
    Beats
{% endblock %}

{% block audiocontrol %}
    {% if is_granted('ROLE_USER') %}
        {#                            <audio style="box-shadow: black 0 0 20px 1px;background:#121212;width: 100%;height: 25px" id="audio" controls></audio>#}
        {% block player %}
            {% include 'includes/player.html.twig' %}
        {% endblock %}
    {% else %}
        <div style="box-shadow: black 0 0 20px 1px;background: #121212;width: 100%;height: 5px;">

        </div>
    {% endif %}
{% endblock %}

{% block filtre %}
    <div class="columns is-flex align-items-center has-background-black-bis" style="margin: 0;position: relative">
        <label class="is-flex align-items-center" for="genres" style="margin: auto 0;">
            <div class="column">
                <strong class="has-text-white is-size-4 is-size-3-touch landscape" style="white-space: nowrap">Genres :</strong>
            </div>
        </label>

        <div id="myBtnContainer" class="buttons are-small column is-flex" style="margin: auto 0;">

            <div class="column is-flex align-items-center justify-content-center">
                <button class="button is-small active is-light is-outlined is-family-sans-serif font-weight-bold is-size-5-touch" style="margin: auto 0;padding: 2px auto;" type="submit" onclick="filterSelection('all')"> All</button>
            </div>

            {% for filtre in filtre %}

                <div class="column is-flex align-items-center justify-content-center">

                    <button class="button is-small is-light is-outlined is-family-sans-serif font-weight-bold is-size-5-touch" value="{{ filtre.genre }}" style="margin: auto 0;padding: 2px auto;" type="submit"  onclick="filterSelection('{{ filtre.genre }}')">
                        {{ filtre.genre }}
                    </button>

                </div>

            {% endfor %}

        </div>

    </div>
{% endblock %}

{% block content %}

    <div class="column">
        <div class="column has-text-centered box" style="background: rgba(23,162,176,0.7);box-shadow: rgb(0, 0, 0) 0px 0px 15px;">

            {% include 'beats/original_beats.html.twig' with {beat: beat} %}

        </div>

        <div class="column has-text-centered box" style="background: rgba(220,53,69,0.7);box-shadow: rgb(0, 0, 0) 0px 0px 15px;">

            {% include 'beats/beatstars.html.twig' with {beat: beat} %}

        </div>
    </div>

    {% include 'lightbox/modal_lightbox.html.twig' %}

    {#      SCRIPT POUR FILTRE BEATS      #}

    <script>
        filterSelection("all")
        function filterSelection(c) {
            var x, i;
            x = document.getElementsByClassName("filterDiv");
            if (c === "all") c = "";
            // Add the "show" class (display:block) to the filtered elements, and remove the "show" class from the elements that are not selected
            for (i = 0; i < x.length; i++) {
                w3RemoveClass(x[i], "show");
                if (x[i].className.indexOf(c) > -1) w3AddClass(x[i], "show");
            }
        }

        // Show filtered elements
        function w3AddClass(element, name) {
            var i, arr1, arr2;
            arr1 = element.className.split(" ");
            arr2 = name.split(" ");
            for (i = 0; i < arr2.length; i++) {
                if (arr1.indexOf(arr2[i]) == -1) {
                    element.className += " " + arr2[i];
                }
            }
        }

        // Hide elements that are not selected
        function w3RemoveClass(element, name) {
            var i, arr1, arr2;
            arr1 = element.className.split(" ");
            arr2 = name.split(" ");
            for (i = 0; i < arr2.length; i++) {
                while (arr1.indexOf(arr2[i]) > -1) {
                    arr1.splice(arr1.indexOf(arr2[i]), 1);
                }
            }
            element.className = arr1.join(" ");
        }

        // Add active class to the current control button (highlight it)
        var btnContainer = document.getElementById("myBtnContainer");
        var btns = btnContainer.getElementsByClassName("button");
        for (var i = 0; i < btns.length; i++) {
            btns[i].addEventListener("click", function() {
                var current = document.getElementsByClassName("active");
                current[0].className = current[0].className.replace(" active", "");
                this.className += " active";
            });
        }
    </script>

    {#      FIN SCRIPT POUR FILTRE BEATS      #}


    {#   SCRIPT PLYR   #}
    <script>
        var players = Plyr.setup('.js-plyr', {
            "controls":['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions','pip', 'airplay', 'fullscreen']
        });

        {#   AUTOPAUSE   #}
        var i = 1;


        players.forEach(function (instance) {
            instance.on('ready', function (event) {
                instance.elements.container.setAttribute('id', 'plyId-' + i);
                instance.plyId = 'plyr-' + i;
                let lenght = players.length;
                var j = i+1;
                if (j > lenght){
                    j = 1;
                }
                let nextId = 'plyId-' + j;
                i++;
                instance.on('ended', function (event) {
                    console.log(nextId);
                    let nextBeat = document.getElementById(nextId);
                    console.log(nextBeat.children[1]);
                    nextBeat.children[1].play();
                });
            });
            instance.on('play', function (event) {
                var currentPid = instance.plyId;
                players.forEach(function (instance) {
                    if (currentPid != instance.plyId) {
                        instance.pause();
                    }
                });
            });

        });

        {#  FIN AUTOPAUSE   #}

    </script>
    {#  FIN SCRIPT PLYR   #}



    {#  SCRIPT VISU SOUND WAVE    #}

    <script>

        window.onload = function() {

            var file = document.getElementById("thefile");

            var audio = document.getElementById("audio");

            file.onchange = function() {
                var files = this.files;
                audio.src = URL.createObjectURL(files[0]);
                audio.load();
                audio.play();
                var context = new AudioContext();
                var src = context.createMediaElementSource(audio);
                var analyser = context.createAnalyser();

                var canvas = document.getElementById("canvas");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight * 0.3 ;
                var ctx = canvas.getContext("2d");

                src.connect(analyser);
                analyser.connect(context.destination);

                analyser.fftSize = 512;

                var bufferLength = analyser.frequencyBinCount;

                var dataArray = new Uint8Array(bufferLength);

                var WIDTH = canvas.width;
                var HEIGHT = canvas.height;

                var barWidth = (WIDTH / bufferLength) * 2.5;
                var barHeight;
                var x = 0;

                function renderFrame() {
                    requestAnimationFrame(renderFrame);

                    x = 0;

                    analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = "#121212";
                    ctx.strokeStyle = "rgba(0,0,0,1)";
                    ctx.lineCap = 'round';
                    ctx.fillRect(0, 0, WIDTH, HEIGHT);

                    for (var i = 0; i < bufferLength; i++) {
                        barHeight = dataArray[i];

                        var r = barHeight;
                        var g = barHeight;
                        var b = 2;

                        ctx.fillStyle = "rgb(" + r + "," + g + ",255)";
                        ctx.lineCap = 'round';
                        ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

                        x += barWidth + 1;
                    }
                }

                audio.play();
                renderFrame();
            };
        };
    </script>

    {# FIN SCRIPT VISU SOUND WAVE    #}

    {#   SCRIPT POUR LIGHTBOX MODAL   #}
    <script>
        $(".showModal").click(function() {
            $(".modal").addClass("is-active");
        });

        $(".modal-close").click(function() {
            $(".modal").removeClass("is-active");
        });

        $(".modal-background").click(function() {
            $(".modal").removeClass("is-active");
        });

    </script>
    {#  FIN SCRIPT POUR LIGHTBOX MODAL   #}

{% endblock %}




